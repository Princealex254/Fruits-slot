<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Fruit Slots ‚Äî Prince Alex</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#2a0247">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

  <style>
    :root{
      --bg-1:#120012;
      --bg-2:#2a0247;
      --accent-1:#ffd24d;
      --accent-2:#ff6b6b;
      --muted:#bdbdbd;
      --max-width:600px;
      --safe-tap:44px;
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter, system-ui, sans-serif}
    body{
      background:linear-gradient(180deg,var(--bg-1),var(--bg-2));
      color:#fff;display:flex;align-items:center;justify-content:center;padding:18px;
    }

    .app-frame{width:100%;max-width:var(--max-width);border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.6);overflow:hidden;background:rgba(0,0,0,0.2)}
    header.app-header{display:flex;align-items:center;justify-content:space-between;padding:12px}
    .logo{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--accent-1),#ff9a49);display:flex;align-items:center;justify-content:center;font-weight:800;color:#222}
    .title{font-weight:700;font-size:1rem}
    .balance-pill{padding:6px 12px;border-radius:999px;background:rgba(255,255,255,0.05);display:flex;gap:6px;align-items:center}
    .balance-pill .amount{font-weight:800;color:var(--accent-1)}
    .game-shell{padding:12px}

    .board{display:grid;grid-template-columns:repeat(7,1fr);grid-template-rows:repeat(7,1fr);gap:4px;max-width:100%;margin:auto;aspect-ratio:1;border:3px solid rgba(255,255,255,0.05);border-radius:12px;position:relative;}
    .slot-item{display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.05);border-radius:8px;font-weight:700;transition:transform .2s;color:transparent;transition:background-color 0.1s;}
    .slot-item span { color: #fff; text-shadow: 0 0 5px rgba(0,0,0,0.5); }
    .slot-item .small-text{font-size:0.6rem;color:var(--accent-1);margin-left:2px}
    
    .slot-item[data-fruit="big-orange-top-left"] { grid-column: 1; grid-row: 1; }
    .slot-item[data-fruit="big-bell-top"] { grid-column: 2; grid-row: 1; }
    .slot-item[data-fruit="small-bar-x50"] { grid-column: 3; grid-row: 1; }
    .slot-item[data-fruit="big-bar"] { grid-column: 4; grid-row: 1; }
    .slot-item[data-fruit="apple-x5"] { grid-column: 5; grid-row: 1; }
    .slot-item[data-fruit="small-apple-x3-top"] { grid-column: 6; grid-row: 1; }
    .slot-item[data-fruit="big-mango-top-right"] { grid-column: 7; grid-row: 1; }
    .slot-item[data-fruit="small-bell-x3-left"] { grid-column: 1; grid-row: 2; }
    .slot-item[data-fruit="apple-left-middle"] { grid-column: 1; grid-row: 3; }
    .slot-item[data-fruit="lucky-tab-left"] { grid-column: 1; grid-row: 4; }
    .slot-item[data-fruit="small-star-x3-left"] { grid-column: 1; grid-row: 5; }
    .slot-item[data-fruit="big-double-star-left"] { grid-column: 1; grid-row: 6; }
    .slot-item[data-fruit="big-watermelon-right"] { grid-column: 7; grid-row: 2; }
    .slot-item[data-fruit="small-watermelon-x3-right"] { grid-column: 7; grid-row: 3; }
    .slot-item[data-fruit="lucky-tab-right"] { grid-column: 7; grid-row: 4; }
    .slot-item[data-fruit="apple-right-middle"] { grid-column: 7; grid-row: 5; }
    .slot-item[data-fruit="small-orange-x3-right"] { grid-column: 7; grid-row: 6; }
    .slot-item[data-fruit="big-mango-bottom-left"] { grid-column: 1; grid-row: 7; }
    .slot-item[data-fruit="small-mango-x3-bottom"] { grid-column: 2; grid-row: 7; }
    .slot-item[data-fruit="apple-bottom-middle"] { grid-column: 3; grid-row: 7; }
    .slot-item[data-fruit="big-77-bottom"] { grid-column: 4; grid-row: 7; }
    .slot-item[data-fruit="small-7-x3-bottom"] { grid-column: 5; grid-row: 7; }
    .slot-item[data-fruit="big-bell-bottom"] { grid-column: 6; grid-row: 7; }
    .slot-item[data-fruit="big-orange-bottom-right"] { grid-column: 7; grid-row: 7; }

    .center-display {
      grid-column: 2 / span 5;
      grid-row: 2 / span 5;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      font-weight: 800;
      color: var(--accent-1);
      z-index: 10;
    }

    .glowing-label{font-size:0.8rem;text-transform:uppercase;letter-spacing:2px;animation:glow-pulse 1s infinite alternate}
    .winning-display{font-size:3rem;text-shadow:0 0 10px var(--accent-1)}

    .controls{padding:12px;background:rgba(255,255,255,0.05);border-radius:16px;margin-top:12px;display:flex;flex-direction:column;gap:12px}
    .status-row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .stake-card{flex:1;background:rgba(255,255,255,0.05);border-radius:12px;padding:8px 12px;font-size:0.8rem}
    .stake-card .row{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
    .stake-card .value{font-weight:700;color:var(--accent-1)}
    .go-button{width:100px;height:100px;border-radius:50%;background:linear-gradient(45deg,#ff6b6b,#f83d3d);color:#fff;font-size:1.5rem;font-weight:800;border:none;box-shadow:0 5px 15px rgba(255,107,107,0.4);transition:transform .2s,box-shadow .2s;cursor:pointer}
    .go-button:hover{transform:scale(1.05)}
    .go-button:active{transform:scale(0.95);box-shadow:none}
    .go-button:disabled{background:#555;cursor:not-allowed;box-shadow:none;transform:none}
    .bottom-controls{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .btn-pill{padding:8px 16px;background:rgba(255,255,255,0.1);border-radius:999px;border:none;color:#fff;font-weight:600;font-size:0.8rem;cursor:pointer;flex-grow:1}
    .fruit-selection{display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
    .fruit-button{background:rgba(255,255,255,0.1);border:1px solid transparent;border-radius:12px;color:#fff;padding:8px;font-size:1rem;font-weight:600;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;min-width:50px;min-height:50px}
    .fruit-button .count{font-size:0.7rem;font-weight:400;color:var(--muted)}
    .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.8);color:#fff;padding:10px 20px;border-radius:10px;opacity:0;transition:opacity .5s ease-in-out;z-index:100}
    .toast.show{opacity:1}

    @keyframes spin{to{transform:rotate(360deg)}}
    .go-button.spinning{animation:spin 1s linear infinite}
    .slot-item.highlight{background-color:var(--accent-1);box-shadow:0 0 15px var(--accent-1);transform:scale(1.1)}
    .slot-item.win-bounce{animation:win-bounce 0.8s ease-out 3}
    @keyframes win-bounce{
      0%,100%{transform:scale(1);box-shadow:0 0 5px #000}
      50%{transform:scale(1.2);box-shadow:0 0 20px var(--accent-1)}
    }
    .slot-item.blinking{animation:blinking 0.8s infinite alternate}
    .board.blinking{animation:blinking 0.8s infinite alternate}
    @keyframes blinking{from{background-color:var(--accent-1)}to{background-color:rgba(255,255,255,0.05)}}
    .slot-item.bonus-flash {animation: bonus-flash 0.5s infinite alternate;}
    @keyframes bonus-flash {
      from { background-color: rgba(255, 255, 255, 0.05); box-shadow: none; }
      to { background-color: var(--accent-1); box-shadow: 0 0 20px var(--accent-1); }
    }
    .slot-item.bonus-hit-glow {
        background-color: var(--accent-1);
        box-shadow: 0 0 15px var(--accent-1);
        transform: scale(1.1);
    }
    
  </style>
</head>
<body>
  <div class="app-frame">
    <header class="app-header">
      <div class="logo">SL</div>
      <div class="title">FRUIT SLOTS</div>
      <div class="balance-pill"><span class="amount" id="balance">0.00</span></div>
    </header>
    <main>
      <div class="game-shell">
        <div class="board" id="board">
          <div class="slot-item" data-fruit="big-orange-top-left"><span>üçä</span></div>
          <div class="slot-item" data-fruit="big-bell-top"><span>üîî</span></div>
          <div class="slot-item" data-fruit="small-bar-x50"><span>BAR<span class="small-text">x50</span></span></div>
          <div class="slot-item" data-fruit="big-bar"><span>BAR</span></div>
          <div class="slot-item" data-fruit="apple-x5"><span>üçé<span class="small-text">x5</span></span></div>
          <div class="slot-item" data-fruit="small-apple-x3-top"><span>üçé<span class="small-text">x3</span></span></div>
          <div class="slot-item" data-fruit="big-mango-top-right"><span>ü•≠</span></div>
          <div class="slot-item" data-fruit="small-bell-x3-left"><span>üîî<span class="small-text">x3</span></span></div>
          <div class="slot-item" data-fruit="apple-left-middle"><span>üçé</span></div>
          <div class="slot-item" data-fruit="lucky-tab-left"><span>LUCKY</span></div>
          <div class="slot-item" data-fruit="small-star-x3-left"><span>‚≠ê<span class="small-text">x3</span></span></div>
          <div class="slot-item" data-fruit="big-double-star-left"><span>‚≠ê</span></div>
          <div class="slot-item" data-fruit="big-watermelon-right"><span>üçâ</span></div>
          <div class="slot-item" data-fruit="small-watermelon-x3-right"><span>üçâ<span class="small-text">x3</span></span></div>
          <div class="slot-item" data-fruit="lucky-tab-right"><span>LUCKY</span></div>
          <div class="slot-item" data-fruit="apple-right-middle"><span>üçé</span></div>
          <div class="slot-item" data-fruit="small-orange-x3-right"><span>üçä<span class="small-text">x3</span></span></div>
          <div class="slot-item" data-fruit="big-mango-bottom-left"><span>ü•≠</span></div>
          <div class="slot-item" data-fruit="small-mango-x3-bottom"><span>ü•≠<span class="small-text">x3</span></span></div>
          <div class="slot-item" data-fruit="apple-bottom-middle"><span>üçé</span></div>
          <div class="slot-item" data-fruit="big-77-bottom"><span>7Ô∏è‚É£</span></div>
          <div class="slot-item" data-fruit="small-7-x3-bottom"><span>7Ô∏è‚É£<span class="small-text">x3</span></span></div>
          <div class="slot-item" data-fruit="big-bell-bottom"><span>üîî</span></div>
          <div class="slot-item" data-fruit="big-orange-bottom-right"><span>üçä</span></div>
          
          <div class="center-display">
            <div class="glowing-label">FRUIT SLOTS</div>
            <div class="winning-display" id="winning">00</div>
          </div>
        </div>
      </div>
      <div class="controls">
        <div class="status-row">
          <div class="stake-card">
            <div class="row"><span>Stake</span><span class="value" id="stake">0.00</span></div>
            <div class="row"><span>Win</span><span class="value" id="win">0.00</span></div>
            <div class="row"><span>Available</span><span class="value" id="available">10000.00</span></div>
          </div>
          <button class="go-button" id="go">GO</button>
        </div>
        <div class="bottom-controls">
          <button class="btn-pill" id="allx1">ALL+1</button>
          <button class="btn-pill" id="left">‚Üê</button>
          <button class="btn-pill" id="right">‚Üí</button>
          <button class="btn-pill" id="range1">1-7</button>
          <button class="btn-pill" id="range2">8-14</button>
          <button class="btn-pill" id="clear">CLEAR</button>
        </div>
        <div class="fruit-selection" id="fruitSel"></div>
      </div>
    </main>
    <div class="toast" id="toast">Hello</div>
  </div>

  <script>
    const balanceEl = document.getElementById('balance');
    const availableEl = document.getElementById('available');
    const stakeEl = document.getElementById('stake');
    const winEl = document.getElementById('win');
    const goBtn = document.getElementById('go');
    const fruitSel = document.getElementById('fruitSel');
    const toast = document.getElementById('toast');
    const winningEl = document.getElementById('winning');
    const boardEl = document.getElementById('board');

    let accountBalance = parseFloat(localStorage.getItem('pa_balance') || 10000);
    let currentBetAmount = 10;
    let MAX_MULT = 5;
    let selectedFruits = {};
    let currentStake = 0;

    function format(n) {
      return Number(n).toFixed(2);
    }

    function setBalance(v) {
      balanceEl.textContent = format(v);
      availableEl.textContent = format(v);
      localStorage.setItem('pa_balance', v);
    }

    setBalance(accountBalance);

    const categories = [{
      key: 'bar',
      emoji: 'BAR'
    }, {
      key: '7',
      emoji: '7Ô∏è‚É£'
    }, {
      key: 'star',
      emoji: '‚≠ê'
    }, {
      key: 'watermelon',
      emoji: 'üçâ'
    }, {
      key: 'bell',
      emoji: 'üîî'
    }, {
      key: 'mango',
      emoji: 'ü•≠'
    }, {
      key: 'orange',
      emoji: 'üçä'
    }, {
      key: 'apple',
      emoji: 'üçé'
    }];

    function initFruitButtons() {
      categories.forEach(c => {
        const b = document.createElement('button');
        b.className = 'fruit-button';
        b.dataset.key = c.key;
        b.innerHTML = `<div>${c.emoji}</div><div class="count">00</div>`;
        b.addEventListener('click', () => toggleFruit(c.key, b));
        fruitSel.appendChild(b);
      });
    }

    function toggleFruit(key, btn) {
      const count = selectedFruits[key] || 0;
      if (count < MAX_MULT) {
        selectedFruits[key] = count + 1;
        btn.querySelector('.count').textContent = String(count + 1).padStart(2, '0');
      } else {
        delete selectedFruits[key];
        btn.querySelector('.count').textContent = '00';
      }
      recalcStake();
    }

    function recalcStake() {
      let s = 0;
      for (const k in selectedFruits) {
        s += selectedFruits[k] * currentBetAmount;
      }
      currentStake = s;
      stakeEl.textContent = format(currentStake);
    }

    document.getElementById('allx1').addEventListener('click', () => {
      document.querySelectorAll('.fruit-button').forEach(b => {
        const k = b.dataset.key;
        const c = selectedFruits[k] || 0;
        if (c < MAX_MULT) {
          selectedFruits[k] = c + 1;
          b.querySelector('.count').textContent = String(c + 1).padStart(2, '0');
        }
      });
      recalcStake();
    });
    document.getElementById('clear').addEventListener('click', () => {
      selectedFruits = {};
      document.querySelectorAll('.fruit-button').forEach(b => b.querySelector('.count').textContent = '00');
      recalcStake();
    });

    function showToast(msg) {
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 1500);
    }

    const slotItems = [
      document.querySelector('[data-fruit="big-orange-top-left"]'),
      document.querySelector('[data-fruit="big-bell-top"]'),
      document.querySelector('[data-fruit="small-bar-x50"]'),
      document.querySelector('[data-fruit="big-bar"]'),
      document.querySelector('[data-fruit="apple-x5"]'),
      document.querySelector('[data-fruit="small-apple-x3-top"]'),
      document.querySelector('[data-fruit="big-mango-top-right"]'),
      document.querySelector('[data-fruit="big-watermelon-right"]'),
      document.querySelector('[data-fruit="small-watermelon-x3-right"]'),
      document.querySelector('[data-fruit="lucky-tab-right"]'),
      document.querySelector('[data-fruit="apple-right-middle"]'),
      document.querySelector('[data-fruit="small-orange-x3-right"]'),
      document.querySelector('[data-fruit="big-orange-bottom-right"]'),
      document.querySelector('[data-fruit="big-bell-bottom"]'),
      document.querySelector('[data-fruit="small-7-x3-bottom"]'),
      document.querySelector('[data-fruit="big-77-bottom"]'),
      document.querySelector('[data-fruit="apple-bottom-middle"]'),
      document.querySelector('[data-fruit="small-mango-x3-bottom"]'),
      document.querySelector('[data-fruit="big-mango-bottom-left"]'),
      document.querySelector('[data-fruit="big-double-star-left"]'),
      document.querySelector('[data-fruit="small-star-x3-left"]'),
      document.querySelector('[data-fruit="lucky-tab-left"]'),
      document.querySelector('[data-fruit="apple-left-middle"]'),
      document.querySelector('[data-fruit="small-bell-x3-left"]')
    ];
    
    const synth = new Tone.Synth().toDestination();
    async function play(note) {
      await Tone.start();
      synth.triggerAttackRelease(note, '8n');
    }

    let lastStopIndex = 0;

    async function spinTicker(stopIndex, cycles = 2) {
      const totalSteps = cycles * slotItems.length + ((stopIndex - lastStopIndex + slotItems.length) % slotItems.length);
      let delay = 35;
      const easingSteps = 20;

      for (let i = 0; i <= totalSteps; i++) {
        slotItems.forEach(si => si.classList.remove('highlight'));
        const idx = (lastStopIndex + i) % slotItems.length;
        slotItems[idx].classList.add('highlight');

        if (i % 2 === 0) play('C4');

        if (i >= totalSteps - easingSteps) {
          delay += 15;
        }

        await new Promise(r => setTimeout(r, delay));
      }

      lastStopIndex = stopIndex;
      const chosen = slotItems[stopIndex];
      chosen.classList.add('win-bounce');
      play('E4');
      return chosen;
    }
    
    async function bonusTicker(stopIndex, cycles = 1) {
      const totalSteps = cycles * slotItems.length + ((stopIndex - lastStopIndex + slotItems.length) % slotItems.length);
      const delay = 5;

      for (let i = 0; i <= totalSteps; i++) {
        slotItems.forEach(si => si.classList.remove('highlight', 'win-bounce'));
        const idx = (lastStopIndex + i) % slotItems.length;
        slotItems[idx].classList.add('highlight');
        if (i % 2 === 0) play('C4');
        await new Promise(r => setTimeout(r, delay));
      }
      lastStopIndex = stopIndex;
      const chosen = slotItems[stopIndex];
      chosen.classList.add('blinking');
      play('E4');
      return chosen;
    }

    async function fullBoardBonusTicker(stopIndex, cycles = 2.5) {
        const totalSteps = Math.floor(cycles * slotItems.length);
        let delay = 5;

        for (let i = 0; i <= totalSteps; i++) {
            slotItems.forEach(si => si.classList.remove('highlight'));
            const idx = (lastStopIndex + i) % slotItems.length;
            slotItems[idx].classList.add('highlight');

            play('C4');
            await new Promise(r => setTimeout(r, delay));
        }

        lastStopIndex = stopIndex;
        const chosen = slotItems[stopIndex];
        return chosen;
    }
    
    function shuffle(array) {
      let currentIndex = array.length, randomIndex;
      while (currentIndex !== 0) {
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex--;
        [array[currentIndex], array[randomIndex]] = [array[currentIndex], array[randomIndex]];
      }
      return array;
    }
    
    function calculatePayout(fruitElement, selectedFruits, currentBetAmount) {
      let totalWin = 0;
      let multiplier = 0;
      const dataFruit = fruitElement.dataset.fruit;
      const rand = Math.random();

      if (dataFruit.includes('bar-x50')) {
          multiplier = 50;
      } else if (dataFruit.includes('apple-x5')) {
          multiplier = 5;
      } else if (dataFruit.includes('x3')) {
          multiplier = 3;
      } else if (dataFruit.includes('big-orange') || dataFruit.includes('big-mango') || dataFruit.includes('big-bell')) {
          if (rand < 0.05) {
              multiplier = Math.random() < 0.5 ? 15 : 20;
          } else {
              multiplier = 10;
          }
      } else if (dataFruit.includes('big-watermelon') || dataFruit.includes('big-double-star') || dataFruit.includes('big-77')) {
          if (rand < 0.05) {
              multiplier = Math.random() < 0.5 ? 30 : 40;
          } else {
              multiplier = 20;
          }
      } else if (dataFruit.includes('lucky-tab')) {
          multiplier = 0; // Lucky Tab has no direct payout, only triggers bonus
      } else if (dataFruit.includes('apple') || dataFruit.includes('big-bar')) {
          multiplier = 0; // These fruits only pay in specific bonuses
      }


      const fruitText = fruitElement.textContent.trim();
      const fruitKey = categories.find(c => fruitText.includes(c.emoji.trim()))?.key;

      if (selectedFruits[fruitKey]) {
          totalWin = selectedFruits[fruitKey] * currentBetAmount * multiplier;
      }
      
      return totalWin;
    }
    
    async function handleX3BonusSequence() {
      showToast("X3 BONUS ACTIVATED!");
      let totalWin = 0;
      // Get all fruits with "x3" in their text content
      const x3Fruits = slotItems.filter(item => item.textContent.includes('x3'));
      const shuffledFruits = shuffle(x3Fruits);

      // Loop through each x3 fruit
      for (const fruit of shuffledFruits) {
        const index = slotItems.indexOf(fruit);
        // Spin the ticker 2.5 times and stop on the current fruit
        await fullBoardBonusTicker(index, 2.5);
        
        // Keep the fruit glowing after it is hit
        fruit.classList.add('bonus-hit-glow');
        
        const win = calculatePayout(fruit, selectedFruits, currentBetAmount);
        totalWin += win;
        winEl.textContent = format(totalWin);
        accountBalance += win;
        setBalance(accountBalance);
      }
      winningEl.textContent = totalWin > 0 ? Math.round(totalWin) : '00';
    }

    async function handleBigFruitsBonusSequence() {
      showToast("Big Fruits Bonus!");
      let totalWin = 0;
      const bigFruits = slotItems.filter(item => {
        const text = item.textContent.trim();
        return (text.includes('üçä') || text.includes('ü•≠') || text.includes('üîî')) && !text.includes('x3');
      });
      const shuffledFruits = shuffle(bigFruits);

      for (const fruit of shuffledFruits) {
        const index = slotItems.indexOf(fruit);
        await fullBoardBonusTicker(index, 2.5); // Use the FullBoard ticker logic
        fruit.classList.add('bonus-hit-glow'); // Keep the fruit lit
        const win = calculatePayout(fruit, selectedFruits, currentBetAmount);
        totalWin += win;
        winEl.textContent = format(totalWin);
        accountBalance += win;
        setBalance(accountBalance);
      }
      winningEl.textContent = totalWin > 0 ? Math.round(totalWin) : '00';
    }
    
    async function handleFullBoardBonus() {
        showToast("FULL BOARD BONUS!");
        boardEl.classList.add('blinking');
        await new Promise(r => setTimeout(r, 1500));
        boardEl.classList.remove('blinking');

        let totalWin = 0;
        const shuffledItems = shuffle([...slotItems]);

        for (const fruit of shuffledItems) {
            const index = slotItems.indexOf(fruit);
            await fullBoardBonusTicker(index, 2.5); // Spin 2.5 times and stop on the fruit.
            
            // Add a persistent glow to the fruit after being hit
            fruit.classList.add('bonus-hit-glow');
            play('C4');

            const win = calculatePayout(fruit, selectedFruits, currentBetAmount);
            totalWin += win;
            if (win > 0) {
                accountBalance += win;
                setBalance(accountBalance);
            }
            winEl.textContent = format(totalWin);
        }

        // Final board celebration
        boardEl.classList.add('blinking');
        await new Promise(r => setTimeout(r, 2000));
        boardEl.classList.remove('blinking');
        
        if (totalWin > 0) {
          confetti({ particleCount: 150, spread: 120, origin: { y: 0.5 } });
          play('C6');
          showToast(`You won ${totalWin.toFixed(2)}`);
        }
        
        winningEl.textContent = totalWin > 0 ? Math.round(totalWin) : '00';
    }

    async function handleAllApplesBonusSequence() {
        showToast("All Apples Bonus!");
        let totalWin = 0;
        const allApples = slotItems.filter(item => {
            const text = item.textContent.trim();
            return text.includes('üçé') && !text.includes('x3');
        });
        const shuffledFruits = shuffle(allApples);

        for (const apple of shuffledFruits) {
            const index = slotItems.indexOf(apple);
            await fullBoardBonusTicker(index, 2.5);
            apple.classList.add('bonus-hit-glow');
            const win = calculatePayout(apple, selectedFruits, currentBetAmount);
            totalWin += win;
            winEl.textContent = format(totalWin);
            accountBalance += win;
            setBalance(accountBalance);
        }
        winningEl.textContent = totalWin > 0 ? Math.round(totalWin) : '00';
    }

    async function handleBarBonus() {
      showToast("BAR BONUS!");
      play(['C2', 'G2']); // Play a low, metallic sound for the BAR bonus intro.

      const barFruits = slotItems.filter(item => item.textContent.includes('BAR'));
      barFruits.forEach(item => item.classList.add('bonus-flash'));
      await new Promise(r => setTimeout(r, 5000));
      barFruits.forEach(item => {
        item.classList.remove('bonus-flash');
        item.classList.add('bonus-hit-glow');
      });

      const nonBarFruits = slotItems.filter(item => !item.textContent.includes('BAR'));
      const shuffledFruits = shuffle(nonBarFruits);
      const numHits = Math.floor(Math.random() * 3) + 2;
      const luckyHits = shuffledFruits.slice(0, numHits);

      let totalWin = 0;

      for (const fruit of luckyHits) {
        const index = slotItems.indexOf(fruit);
        await bonusTicker(index, 1);
        fruit.classList.add('bonus-hit-glow'); // Keep the hit fruit glowing
        play('C4');

        const win = calculatePayout(fruit, selectedFruits, currentBetAmount);
        totalWin += win;
        winEl.textContent = format(totalWin);
        accountBalance += win;
        setBalance(accountBalance);
      }
      
      if (totalWin > 0) {
        confetti({
          particleCount: 80,
          spread: 70,
          origin: { y: 0.35 }
        });
        play('C6');
        showToast(`You won ${totalWin.toFixed(2)}`);
      }
      
      winningEl.textContent = totalWin > 0 ? Math.round(totalWin) : '00';
    }
    
    async function handleLuckyTabBonus() {
      showToast("LUCKY BONUS!");
      const luckyTabs = slotItems.filter(item => item.textContent.includes('LUCKY'));
      luckyTabs.forEach(item => item.classList.add('bonus-flash'));
      play(['C5', 'G5']); // Play a high, pleasant sound
      await new Promise(r => setTimeout(r, 2000));
      luckyTabs.forEach(item => {
        item.classList.remove('bonus-flash');
        item.classList.add('bonus-hit-glow');
      });
      
      const nonLuckyFruits = slotItems.filter(item => !item.textContent.includes('LUCKY'));
      const shuffledFruits = shuffle(nonLuckyFruits);
      const numHits = Math.floor(Math.random() * 2) + 2; // 2 or 3 hits
      const luckyHits = shuffledFruits.slice(0, numHits);
      let totalWin = 0;

      for (const fruit of luckyHits) {
        const index = slotItems.indexOf(fruit);
        await bonusTicker(index, Math.floor(Math.random() * 2) + 1); // 1-2 quick cycles
        fruit.classList.add('bonus-hit-glow');
        const win = calculatePayout(fruit, selectedFruits, currentBetAmount);
        totalWin += win;
        winEl.textContent = format(totalWin);
        accountBalance += win;
        setBalance(accountBalance);
      }

      if (totalWin > 0) {
        confetti({ particleCount: 150, spread: 120, origin: { y: 0.5 } });
        play('C6');
        showToast(`You won ${totalWin.toFixed(2)}`);
      }
      winningEl.textContent = totalWin > 0 ? Math.round(totalWin) : '00';
    }

    async function handleNormalRound(chosen) {
      const totalWin = calculatePayout(chosen, selectedFruits, currentBetAmount);
      
      if (totalWin > 0) {
        confetti({
          particleCount: 80,
          spread: 70,
          origin: { y: 0.35 }
        });
        play('C6');
        showToast(`You won ${totalWin.toFixed(2)}`);
      }

      accountBalance += totalWin;
      setBalance(accountBalance);
      winEl.textContent = format(totalWin);
      winningEl.textContent = totalWin > 0 ? Math.round(totalWin) : '00';
    }

    async function handleBonusRound() {
      slotItems.forEach(si => si.classList.remove('bonus-hit-glow', 'highlight', 'win-bounce', 'blinking'));
      boardEl.classList.add('blinking');
      showToast("BONUS ROUND!");
      await new Promise(r => setTimeout(r, 2000));
      boardEl.classList.remove('blinking');

      const bonusTypes = [
        handleFullBoardBonus,
        handleX3BonusSequence,
        handleBigFruitsBonusSequence,
        handleAllApplesBonusSequence,
        handleBarBonus
      ];
      const randomBonus = bonusTypes[Math.floor(Math.random() * bonusTypes.length)];
      await randomBonus();
    }

    async function spin() {
      if (currentStake === 0) {
        showToast('Select fruits');
        return;
      }
      if (accountBalance < currentStake) {
        showToast('Insufficient balance');
        return;
      }
      
      accountBalance -= currentStake;
      setBalance(accountBalance);
      goBtn.disabled = true;
      goBtn.classList.add('spinning');
      winEl.textContent = '0.00';
      winningEl.textContent = '00';
      slotItems.forEach(si => si.classList.remove('highlight', 'win-bounce', 'blinking', 'bonus-hit-glow'));

      const stopIndex = Math.floor(Math.random() * slotItems.length);
      const chosen = await spinTicker(stopIndex);

      if (chosen.dataset.fruit.includes('lucky-tab')) {
        await handleLuckyTabBonus();
      } else {
        const isSpecialMode = Math.random() < 0.08; // 8% chance for a Special Mode bonus
        if (isSpecialMode) {
          await handleBonusRound();
        } else {
          await handleNormalRound(chosen);
        }
      }

      goBtn.disabled = false;
      goBtn.classList.remove('spinning');
    }

    goBtn.addEventListener('click', spin);
    initFruitButtons();
  </script>
</body>
</html>
