<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fruit Slots</title>
    <style>
        /* CSS Styling */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            color: #eee;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden; /* Prevent horizontal scroll */
            align-items: center; /* Center content horizontally */
            /* Added background gradient */
            background: linear-gradient(to bottom, #8e2de2, #4a00e0); /* Purple gradient background */
        }

        .header {
            background-color: #6a0dad; /* Purple */
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.2em;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.7);
            z-index: 10;
            width: 100%; /* Full width header */
            box-sizing: border-box; /* Include padding in width */
        }

        .account-balance {
            font-weight: bold;
            letter-spacing: 0.5px;
        }

        .menu-icon {
            cursor: pointer;
            font-size: 1.8em;
            padding: 0 5px;
            color: #ffeb3b; /* Yellow */
        }

        /* New mobile frame wrapper */
        .mobile-frame {
            width: 100%;
            max-width: 420px; /* narrow like phone screen */
            margin: auto;
            background: #300; /* Dark reddish background for the frame */
            border-radius: 40px; /* Rounded corners for phone shape */
            padding: 5px; /* Reduced padding inside the frame */
            box-shadow: 0 0 20px #000; /* Shadow for depth */
            display: flex; /* To center the game-area-wrapper */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            flex-grow: 1; /* Allow it to grow and take available space */
            min-height: 0; /* Important for flex children */
        }

        /* Main game area container - represents the entire slot machine body */
        .game-area-wrapper {
            flex-grow: 1; /* Allow it to fill the mobile-frame height */
            display: flex;
            flex-direction: column; /* Stack sections vertically */
            align-items: center; /* Center content horizontally */
            width: 100%;
            height: auto; /* Changed to auto to work with content */
            min-height: 0; /* Important for flex items to prevent overflow */
            margin: 0 auto; /* Center within mobile-frame */
            background: linear-gradient(to bottom, #922b2b, #b33939); /* Keep machine color */
            border-radius: 25px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            padding: 5px; /* Reduced padding around the internal components */
            box-sizing: border-box;
            border: 5px solid #ffeb3b; /* Gold border for the machine */
        }

        /* Game board - where the fruits spin */
        .game-board {
            position: relative;
            width: 100%; /* Changed to 100% */
            height: auto; /* Changed to auto */
            aspect-ratio: 1 / 1.2; /* Slightly taller than wide */
            max-width: 380px; /* New: Max width for the board itself */
            max-height: unset; /* Removed max-height to allow aspect-ratio to control */
            background: linear-gradient(145deg, #922b2b, #b33939); /* Reddish gradient */
            border-radius: 25px;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.9), 0 0 30px rgba(255, 215, 0, 0.7), 0 0 60px rgba(255, 165, 0, 0.5); /* Intense glow */
            display: grid;
            grid-template-columns: repeat(7, 1fr); /* 7 columns for 24 items */
            grid-template-rows: repeat(7, 1fr);    /* 7 rows for 24 items */
            padding: 5px; /* Reduced padding */
            box-sizing: border-box;
            border: 5px solid #ffeb3b; /* Gold border */
            min-width: unset; /* Removed */
            min-height: unset; /* Removed */
            margin-bottom: 5px; /* Reduced space below the board */
        }

        /* Precise positioning for 24 fruits/symbols on a 7x7 grid. */
        /* Order follows user's detailed description, clockwise from top-left. */

        /* Top Row (7 items: 1-7) */
        .slot-item:nth-child(1) { grid-column: 1; grid-row: 1; } /* Big orange image */
        .slot-item:nth-child(2) { grid-column: 2; grid-row: 1; } /* Big bell image */
        .slot-item:nth-child(3) { grid-column: 3; grid-row: 1; } /* Small Bar with small x50 on it */
        .slot-item:nth-child(4) { grid-column: 4; grid-row: 1; } /* Big Bar */
        .slot-item:nth-child(5) { grid-column: 5; grid-row: 1; } /* Apple image (x5) */
        .slot-item:nth-child(6) { grid-column: 6; grid-row: 1; } /* small apple with small x3 on it */
        .slot-item:nth-child(7) { grid-column: 7; grid-row: 1; } /* big mango image (Top-Right Corner) */

        /* Right Column (6 items: 8-13, excluding top-right and bottom-right corners) */
        .slot-item:nth-child(8) { grid-column: 7; grid-row: 2; } /* Big watermelon image */
        .slot-item:nth-child(9) { grid-column: 7; grid-row: 3; } /* small water mellon with x3 on it */
        .slot-item:nth-child(10) { grid-column: 7; grid-row: 4; } /* small tab indicated Lucky */
        .slot-item:nth-child(11) { grid-column: 7; grid-row: 5; } /* image of Apple */
        .slot-item:nth-child(12) { grid-column: 7; grid-row: 6; } /* small orange with x3 written on it */
        .slot-item:nth-child(13) { grid-column: 7; grid-row: 7; } /* Big orange (Bottom-Right Corner) */

        /* Bottom Row (6 items: 14-19, excluding bottom-right and bottom-left corners, reversed order) */
        .slot-item:nth-child(14) { grid-column: 6; grid-row: 7; } /* Big bell image */
        .slot-item:nth-child(15) { grid-column: 5; grid-row: 7; } /* small 7 with x3 on it */
        .slot-item:nth-child(16) { grid-column: 4; grid-row: 7; } /* Big 77 */
        .slot-item:nth-child(17) { grid-column: 3; grid-row: 7; } /* Apple image */
        .slot-item:nth-child(18) { grid-column: 2; grid-row: 7; } /* small mango with x3 on it */
        .slot-item:nth-child(19) { grid-column: 1; grid-row: 7; } /* Big mango (Bottom-Left Corner) */

        /* Left Column (5 items: 20-24) */
        .slot-item:nth-child(20) { grid-column: 1; grid-row: 6; } /* Big double star */
        .slot-item:nth-child(21) { grid-column: 1; grid-row: 5; } /* Small star with x3 on it */
        .slot-item:nth-child(22) { grid-column: 1; grid-row: 4; } /* small tab indicated Lucky */
        .slot-item:nth-child(23) { grid-column: 1; grid-row: 3; } /* Apple image */
        .slot-item:nth-child(24) { grid-column: 1; grid-row: 2; } /* small bell image with x3 on it */


        .slot-item {
            /* Increased font size for larger emojis */
            font-size: 1.6em; /* Slightly reduced font size */
            display: flex;
            flex-direction: column; /* Allow content to stack */
            justify-content: center;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.08); /* Slightly transparent white */
            border-radius: 8px;
            border: 2px solid rgba(255, 255, 255, 0.2); /* Clearer border */
            position: relative;
            overflow: hidden;
            color: white; /* For BAR/X3/Lucky text */
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            font-weight: bold;
            transition: transform 0.1s ease-out, box-shadow 0.1s ease-out; /* Smooth highlight */
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3); /* Subtle initial glow */
            text-align: center; /* Center text within the slot */
            line-height: 1; /* Tightened line height */
            padding: 0px; /* Removed padding to maximize content space */
            box-sizing: border-box; /* Include padding in element size */
        }

        /* Specific adjustments for text-based symbols */
        .slot-item[data-fruit="big-77-bottom"],
        .slot-item[data-fruit="big-double-star-left"],
        .slot-item[data-fruit="big-bar"],
        .slot-item[data-fruit="small-bar-x50"] {
            font-size: 1.2em; /* Slightly smaller to ensure fit */
        }

        .slot-item span.small-text {
            /* Further reduced font size for multipliers */
            font-size: 0.35em; /* Significantly reduced relative to parent */
            display: block; /* Ensure it's on a new line */
            margin-top: -1px; /* Pull it closer to the emoji */
            color: #ffeb3b; /* Yellow for multipliers */
            text-shadow: none;
        }

        .slot-item.lucky-tab {
            background-color: #3f51b5; /* Blue for Lucky tabs */
            color: white;
            font-size: 0.6em; /* Even smaller font for Lucky tabs */
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 0 10px rgba(63, 81, 181, 0.5);
        }


        .center-display {
            /* Spans columns 2 to 6, and rows 2 to 6, creating a 5x5 center */
            grid-column: 2 / span 5;
            grid-row: 2 / span 5;
            background: linear-gradient(135deg, #6a0dad, #8a2be2); /* Purple gradient */
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.8), inset 0 0 10px rgba(0, 0, 0, 0.5);
            z-index: 1;
            border: 3px solid gold;
        }

        .glowing-label {
            /* Reduced font size for "FRUIT SLOTS" */
            font-size: 1.2em; /* Adjusted to be smaller */
            font-weight: bold;
            color: gold;
            text-shadow: 0 0 15px orange, 0 0 30px yellow, 0 0 45px orange;
            animation: pulse 1.8s infinite alternate ease-in-out;
            letter-spacing: 2px;
        }

        .winning-display {
            font-size: 2.5em; /* Adjusted font size */
            font-weight: bold;
            color: #ccff00; /* Bright green for win numbers */
            margin-top: 5px; /* Reduced margin */
            text-shadow: 0 0 10px #ccff00, 0 0 20px #99ff00;
        }

        /* Highlight animation */
        .slot-item.highlight {
            background-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 25px 7px yellow, inset 0 0 10px yellow;
            transform: scale(1.15); /* More pronounced scale */
            border-color: yellow;
        }

        /* Controls area - contains stake info, GO button, and other control buttons */
        .controls-area {
            width: 100%;
            background-color: #922b2b; /* Match machine body color */
            padding: 5px; /* Reduced padding */
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 5px; /* Reduced gap */
            border-bottom-left-radius: 25px; /* Match machine body border radius */
            border-bottom-right-radius: 25px;
            border-top: 2px solid #ffeb3b; /* Gold border at top */
            box-shadow: inset 0 5px 10px rgba(0, 0, 0, 0.3);
        }

        .top-controls {
            display: flex;
            justify-content: space-between;
            align-items: flex-end; /* Align stake info to bottom of its container */
            gap: 5px; /* Reduced gap */
        }

        .stake-info {
            flex-grow: 1;
            background-color: #555; /* Darker background for stake info block */
            padding: 5px; /* Reduced padding */
            border-radius: 8px;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.3);
            font-size: 0.8em; /* Adjusted font size */
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 2px; /* Reduced gap */
        }
        .stake-info div {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .stake-info span {
            font-weight: bold;
            color: #ccff00; /* Bright green for values */
        }
        .stake-info .available-amount {
            font-size: 0.8em; /* Slightly smaller */
            color: #ccc;
        }
        .stake-info .gift-info {
            font-size: 0.7em; /* Slightly smaller */
            color: #ffeb3b;
        }

        .go-button {
            background: linear-gradient(135deg, #ffc107, #ff9800); /* Yellow-orange gradient */
            color: #333;
            padding: 5px 10px; /* Reduced padding for this GO button */
            border: none;
            border-radius: 8px;
            font-size: 1em; /* Reduced font size */
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease;
            letter-spacing: 1px;
            text-transform: uppercase;
            width: 90px; /* Reduced width */
            height: 50px; /* Reduced height */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            line-height: 1.1; /* Adjust line height for better stacking */
        }
        .go-button .go-subtext {
            font-size: 0.6em; /* Adjusted font size for visibility */
            font-weight: normal;
            margin-top: 1px; /* Reduced margin to pull closer to main text */
            color: #555;
        }
        .go-button:hover {
            background: linear-gradient(135deg, #ffe082, #ffb300);
            transform: translateY(-3px);
            box-shadow: 0 7px 14px rgba(0, 0, 0, 0.6);
        }
        .go-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .bottom-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Allow wrapping on small screens */
            gap: 3px; /* Even smaller gap */
            background-color: #555; /* Background for this row of buttons */
            padding: 5px; /* Reduced padding */
            border-radius: 8px;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.3);
        }

        .control-button {
            background-color: #007bff; /* Blue */
            color: white;
            padding: 5px 8px; /* Reduced padding */
            border: none;
            border-radius: 5px; /* Slightly smaller radius */
            font-size: 0.75em; /* Smaller font */
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s ease, transform 0.1s ease;
            flex-grow: 1;
            min-width: 45px; /* Ensure buttons don't get too small */
            text-transform: uppercase;
        }
        .control-button.arrow-button {
            font-size: 1em; /* Slightly smaller arrows */
            padding: 5px 10px;
        }
        .control-button.range-button {
            background-color: #ffc107; /* Yellow for range buttons */
            color: #333;
        }
        #all-x1 { background-color: #28a745; } /* Green */
        #clear-selection { background-color: #dc3545; } /* Red */

        .control-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        #all-x1:hover { background-color: #218838; }
        #clear-selection:hover { background-color: #c82333; }
        .control-button.range-button:hover { background-color: #e0a800; }


        /* Fruit Selection Grid Styling */
        .fruit-selection-grid {
            display: flex; /* Changed to flexbox */
            flex-wrap: nowrap; /* Prevent wrapping */
            overflow-x: auto; /* Enable horizontal scrolling */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            gap: 3px; /* Even smaller gap between buttons */
            padding: 5px; /* Reduced padding */
            background-color: #922b2b; /* Match machine body color */
            border-radius: 15px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
            border: 2px solid #ffeb3b; /* Gold border */
            width: 100%;
            box-sizing: border-box;
            margin-top: 5px; /* Reduced space from controls-area */
            justify-content: flex-start; /* Align items to the start */
            align-items: center; /* Center items vertically */
        }

        .fruit-selection-grid::-webkit-scrollbar {
            height: 8px; /* Height of the scrollbar */
        }

        .fruit-selection-grid::-webkit-scrollbar-track {
            background: #444; /* Color of the scrollbar track */
            border-radius: 10px;
        }

        .fruit-selection-grid::-webkit-scrollbar-thumb {
            background: #888; /* Color of the scrollbar thumb */
            border-radius: 10px;
        }

        .fruit-selection-grid::-webkit-scrollbar-thumb:hover {
            background: #555; /* Color of the scrollbar thumb on hover */
        }

        .fruit-selection-grid .fruit-button {
            flex-shrink: 0; /* Prevent buttons from shrinking */
            width: 55px; /* Further reduced width for consistency */
            height: 55px; /* Further reduced height for consistency */
            background-color: #28a745; /* Green background for selection buttons */
            color: white;
            padding: 3px 1px; /* Reduced padding */
            border: 2px solid #ffeb3b; /* Gold border */
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em; /* Adjusted emoji size */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between; /* Space between emoji and count */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease;
        }

        .fruit-selection-grid .fruit-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }

        .fruit-selection-grid .fruit-button .selection-count {
            font-size: 0.6em; /* Size for 00, 01, 02 */
            font-weight: bold;
            color: #ccff00; /* Bright green for count */
            background-color: rgba(0, 0, 0, 0.4);
            padding: 1px 4px; /* Reduced padding */
            border-radius: 5px;
            margin-top: 1px; /* Reduced margin */
            min-width: 18px; /* Ensure consistent width */
            text-align: center;
        }


        /* History area - hidden as per image, but kept for potential future use */
        .history-area {
            display: none; /* Hidden as per the provided image */
            width: 100%;
            max-width: 650px;
            margin-top: 20px;
            padding: 20px;
            background-color: #333;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.6);
            margin-bottom: 20px;
            border: 1px solid #555;
            box-sizing: border-box;
        }

        .history-area h3 {
            text-align: center;
            margin-top: 0;
            color: #ffeb3b;
            font-size: 1.5em;
            letter-spacing: 1px;
            margin-bottom: 15px;
        }

        #history-list {
            list-style: none;
            padding: 0;
            max-height: 200px;
            overflow-y: auto;
            background-color: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #444;
        }

        #history-list li {
            padding: 8px 0;
            border-bottom: 1px dashed #444;
            font-size: 0.95em;
            color: #ccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #history-list li:last-child {
            border-bottom: none;
        }

        #history-list::-webkit-scrollbar {
            width: 8px;
        }
        #history-list::-webkit-scrollbar-track {
            background: #3a3a3a;
            border-radius: 10px;
        }
        #history-list::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        #history-list::-webkit-scrollbar-thumb:hover {
            background: #555;
        }


        /* Animations */
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; text-shadow: 0 0 15px orange, 0 0 30px yellow, 0 0 45px orange; }
            50% { transform: scale(1.03); opacity: 0.95; text-shadow: 0 0 20px orange, 0 0 40px yellow, 0 0 60px orange; }
            100% { transform: scale(1); opacity: 1; text-shadow: 0 0 15px orange, 0 0 30px yellow, 0 0 45px orange; }
        }


        /* Media Queries for Responsiveness */

        /* Mobile (vertical layout) - Default styles */
        /* The initial styles are optimized for mobile. */

        /* Desktop (wider screens) */
        @media (min-width: 768px) {
            .mobile-frame {
                max-width: 420px; /* Keep consistent with mobile-first approach */
                padding: 10px; /* Adjusted padding for consistency */
            }

            .game-area-wrapper {
                max-width: 420px; /* Keep consistent with mobile-first approach */
                padding: 10px; /* Adjusted padding for consistency */
            }

            .game-board {
                width: 100%; /* Keep 100% */
                height: auto; /* Keep auto */
                aspect-ratio: 1 / 1.2; /* Slightly taller than wide */
                max-width: 380px; /* Keep consistent with game-area-wrapper */
                padding: 10px; /* Adjusted padding for consistency */
                margin-bottom: 10px; /* Keep reduced margin */
            }

            .slot-item {
                font-size: 1.8em; /* Adjusted to match mobile size, as desktop is now constrained */
            }

            .slot-item span.small-text {
                font-size: 0.4em; /* Adjusted to match mobile size */
            }

            .glowing-label {
                font-size: 1.4em; /* Adjusted to match mobile size */
            }

            .winning-display {
                font-size: 2.8em; /* Adjusted to match mobile size */
            }

            .controls-area {
                padding: 10px; /* Adjusted padding for consistency */
                gap: 10px; /* Adjusted gap */
            }

            .fruit-selection-grid {
                flex-wrap: wrap; /* Allow wrapping on larger screens if desired */
                overflow-x: hidden; /* Hide scrollbar if not needed on wider screens */
                justify-content: center; /* Center buttons on wider screens */
                gap: 5px; /* Adjusted gap */
                padding: 10px; /* Adjusted padding */
                margin-top: 10px; /* Keep reduced margin */
            }

            .fruit-selection-grid .fruit-button {
                width: 80px; /* Slightly larger buttons on desktop */
                height: 70px;
                font-size: 1.3em;
                padding: 5px 3px; /* Adjusted padding */
            }
            .fruit-selection-grid .fruit-button .selection-count {
                font-size: 0.8em;
                padding: 2px 8px; /* Adjusted padding */
                margin-top: 3px; /* Adjusted margin */
            }
        }

        @media (min-width: 1024px) {
            .mobile-frame {
                max-width: 420px; /* Keep consistent, as this is a mobile-app like layout */
            }
            .game-area-wrapper {
                max-width: 420px; /* Keep consistent, as this is a mobile-app like layout */
            }
            .game-board {
                max-width: 380px; /* Keep consistent */
            }
        }
    </style>
    <!-- Tone.js for sound generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
</head>
<body>
    <header class="header">
        <div class="account-balance">Account Balance: KES <span id="balance">10,000.00</span></div>
        <div class="menu-icon">&#9776;</div>
    </header>

    <div class="mobile-frame">
        <main class="game-area-wrapper">
            <div class="game-board">
                <!-- The game-board itself is the grid container. -->
                <!-- The 24 slot items are arranged clockwise from top-left, matching the image. -->
                <!-- Each item's data-fruit attribute corresponds to a key in the fruitsData object in JavaScript. -->
                <!-- Top Row (1-7) -->
                <div class="slot-item" data-fruit="big-orange-top-left">🍊</div> <!-- 1 -->
                <div class="slot-item" data-fruit="big-bell-top">🔔</div> <!-- 2 -->
                <div class="slot-item" data-fruit="small-bar-x50">BAR<span class="small-text">x50</span></div> <!-- 3 -->
                <div class="slot-item" data-fruit="big-bar">BAR</div> <!-- 4 -->
                <div class="slot-item" data-fruit="apple-x5">🍎<span class="small-text">x5</span></div> <!-- 5 -->
                <div class="slot-item" data-fruit="small-apple-x3-top">🍎<span class="small-text">x3</span></div> <!-- 6 -->
                <div class="slot-item" data-fruit="big-mango-top-right">🥭</div> <!-- 7 -->

                <!-- Right Column (6 items: 8-13, excluding top-right and bottom-right corners) -->
                <div class="slot-item" data-fruit="big-watermelon-right">🍉</div> <!-- 8 -->
                <div class="slot-item" data-fruit="small-watermelon-x3-right">🍉<span class="small-text">x3</span></div> <!-- 9 -->
                <div class="slot-item lucky-tab" data-fruit="lucky-tab-right">LUCKY</div> <!-- 10 -->
                <div class="slot-item" data-fruit="apple-right-middle">🍎</div> <!-- 11 -->
                <div class="slot-item" data-fruit="small-orange-x3-right">🍊<span class="small-text">x3</span></div> <!-- 12 -->
                <div class="slot-item" data-fruit="big-orange-bottom-right">🍊</div> <!-- 13 -->

                <!-- Bottom Row (6 items: 14-19, excluding bottom-right and bottom-left corners, reversed order) -->
                <div class="slot-item" data-fruit="big-bell-bottom">🔔</div> <!-- 14 -->
                <div class="slot-item" data-fruit="small-7-x3-bottom">7️⃣<span class="small-text">x3</span></div> <!-- 15 -->
                <div class="slot-item" data-fruit="big-77-bottom">7️⃣7️⃣</div> <!-- 16 -->
                <div class="slot-item" data-fruit="apple-bottom-middle">🍎</div> <!-- 17 -->
                <div class="slot-item" data-fruit="small-mango-x3-bottom">🥭<span class="small-text">x3</span></div> <!-- 18 -->
                <div class="slot-item" data-fruit="big-mango-bottom-left">🥭</div> <!-- 19 -->

                <!-- Left Column (5 items: 20-24) -->
                <div class="slot-item" data-fruit="big-double-star-left">⭐⭐</div> <!-- 20 -->
                <div class="slot-item" data-fruit="small-star-x3-left">⭐<span class="small-text">x3</span></div> <!-- 21 -->
                <div class="slot-item lucky-tab" data-fruit="lucky-tab-left">LUCKY</div> <!-- 22 -->
                <div class="slot-item" data-fruit="apple-left-middle">🍎</div> <!-- 23 -->
                <div class="slot-item" data-fruit="small-bell-x3-left">🔔<span class="small-text">x3</span></div> <!-- 24 -->

                <!-- Center Display -->
                <div class="center-display">
                    <div class="glowing-label">FRUIT SLOTS</div>
                    <div class="winning-display">00</div>
                </div>
            </div>

            <div class="controls-area">
                <div class="top-controls">
                    <div class="stake-info">
                        <div class="stake-amount">
                            Stake: <span>0.00</span>
                        </div>
                        <div class="win-info">
                            Win: <span>0.00</span>
                        </div>
                        <div class="available-amount">
                            KSH <span id="available-balance">10000.00</span> Available
                        </div>
                        <div class="gift-info">
                            🎁 Gift
                        </div>
                    </div>
                    <button id="go-button" class="go-button">GO<br><span class="go-subtext">About to Pay 0</span></button>
                </div>

                <div class="bottom-controls">
                    <button id="all-x1" class="control-button">ALL+1</button>
                    <button class="control-button arrow-button left-arrow">←</button>
                    <button class="control-button arrow-button right-arrow">→</button>
                    <button class="control-button range-button">1-7</button>
                    <button class="control-button range-button">8-14</button>
                    <button id="clear-selection" class="control-button">CLEAR</button>
                </div>
            </div>

            <!-- Fruit Selection Grid (Moved to be below controls-area, inside game-area-wrapper) -->
            <div class="fruit-selection-grid">
                <!-- Buttons will be dynamically populated here by JavaScript -->
            </div>
        </main>
    </div>

    <!-- History area - hidden as per image, but kept for potential future use -->
    <div class="history-area">
        <h3>Last Results</h3>
        <ul id="history-list">
            <!-- History items will be added here by JS -->
        </ul>
    </div>

    <script>
        // JavaScript Logic
        document.addEventListener('DOMContentLoaded', () => {
            const balanceDisplay = document.getElementById('balance');
            const currentStakeDisplay = document.querySelector('.stake-amount span');
            const currentWinDisplay = document.querySelector('.win-info span');
            const availableBalanceDisplay = document.getElementById('available-balance');
            const goSubtext = document.querySelector('.go-subtext');
            const allX1Button = document.getElementById('all-x1');
            const clearSelectionButton = document.getElementById('clear-selection');
            const fruitSelectionGrid = document.querySelector('.fruit-selection-grid');
            const goButton = document.getElementById('go-button');
            const historyList = document.getElementById('history-list');
            const slotItems = Array.from(document.querySelectorAll('.slot-item'));
            const winningDisplay = document.querySelector('.winning-display');

            // Initialize Tone.js Synth for sound effects
            const synth = new Tone.Synth().toDestination();

            // Create a polyphonic synth for simultaneous notes (for hit sounds)
            const polySynth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "sine" },
                envelope: { attack: 0.02, decay: 0.1, sustain: 0.1, release: 0.2 }
            }).toDestination();

            // Create a simple oscillator for the continuous moving sound
            const movingOscillator = new Tone.Oscillator().toDestination();
            movingOscillator.frequency.value = 440; // A4 note
            movingOscillator.type = "sawtooth";
            movingOscillator.volume.value = -15; // Lower volume

            // New Tone.js elements for bonus music - REMOVED .toDestination()
            const x3BonusSequence = new Tone.Sequence((time, note) => {
                polySynth.triggerAttackRelease(note, "8n", time);
            }, ["C5", "E5", "G5", "C6"]);
            x3BonusSequence.loop = 0; // Play once
            x3BonusSequence.playbackRate = 2; // Make it fast

            const bigFruitBonusChord = new Tone.PolySynth(Tone.Synth).toDestination();

            const fullBoardSequence = new Tone.Sequence((time, note) => {
                polySynth.triggerAttackRelease(note, "16n", time);
            }, ["C4", "D4", "E4", "F4", "G4", "A4", "B4", "C5"]);
            fullBoardSequence.loop = 0;
            fullBoardSequence.playbackRate = 3; // Very fast

            const appleBonusMelody = new Tone.Sequence((time, note) => {
                polySynth.triggerAttackRelease(note, "8n", time);
            }, ["C5", "G4", "E4", "C4"]);
            appleBonusMelody.loop = 0;
            appleBonusMelody.playbackRate = 1.5;

            let accountBalance = 10000.00;
            let selectedFruits = {}; // { categoryName: count (1 or 2) }
            let currentStake = 0;
            let currentBetAmount = 10; // Default bet amount

            // Global variable to hold the blinking interval ID for bonus mode
            let bonusBlinkInterval = null;

            // Define all fruits on the board with their specific properties and category
            const fruitsData = {
                // Top Row
                'big-orange-top-left': { emoji: '🍊', multiplier: [10, 20], type: 'range', category: 'orange' },
                'big-bell-top': { emoji: '🔔', multiplier: [10, 20], type: 'range', category: 'bell' },
                'small-bar-x50': { emoji: 'BAR', multiplier: 50, type: 'fixed', category: 'bar' }, // Updated multiplier
                'big-bar': { emoji: 'BAR', multiplier: 100, type: 'fixed', category: 'bar' }, // Updated multiplier
                'apple-x5': { emoji: '🍎', multiplier: 5, type: 'fixed', category: 'apple' },
                'small-apple-x3-top': { emoji: '🍎', multiplier: 3, type: 'fixed', category: 'apple' },
                'big-mango-top-right': { emoji: '🥭', multiplier: [10, 20], type: 'range', category: 'mango' },

                // Right Column
                'big-watermelon-right': { emoji: '🍉', multiplier: [20, 40], type: 'range', category: 'watermelon' },
                'small-watermelon-x3-right': { emoji: '🍉', multiplier: 3, type: 'fixed', category: 'watermelon' },
                'lucky-tab-right': { emoji: 'LUCKY', multiplier: 0, type: 'lucky', category: 'lucky-tab' },
                'apple-right-middle': { emoji: '�', multiplier: 5, type: 'fixed', category: 'apple' },
                'small-orange-x3-right': { emoji: '🍊', multiplier: 3, type: 'fixed', category: 'orange' },
                'big-orange-bottom-right': { emoji: '🍊', multiplier: [10, 20], type: 'range', category: 'orange' },

                // Bottom Row
                'big-bell-bottom': { emoji: '🔔', multiplier: [10, 20], type: 'range', category: 'bell' },
                'small-7-x3-bottom': { emoji: '7️⃣', multiplier: 3, type: 'fixed', category: '7' },
                'big-77-bottom': { emoji: '7️⃣7️⃣', multiplier: [20, 40], type: 'range', category: '7' },
                'apple-bottom-middle': { emoji: '🍎', multiplier: 5, type: 'fixed', category: 'apple' },
                'small-mango-x3-bottom': { emoji: '🥭', multiplier: 3, type: 'fixed', category: 'mango' },
                'big-mango-bottom-left': { emoji: '🥭', multiplier: [10, 20], type: 'range', category: 'mango' },

                // Left Column
                'big-double-star-left': { emoji: '⭐⭐', multiplier: [20, 40], type: 'range', category: 'star' },
                'small-star-x3-left': { emoji: '⭐', multiplier: 3, type: 'fixed', category: 'star' },
                'lucky-tab-left': { emoji: 'LUCKY', multiplier: 0, type: 'lucky', category: 'lucky-tab' },
                'apple-left-middle': { emoji: '🍎', multiplier: 5, type: 'fixed', category: 'apple' },
                'small-bell-x3-left': { emoji: '🔔', multiplier: 3, type: 'fixed', category: 'bell' }
            };

            // Define the categories for the betting grid
            const bettingCategories = [
                { key: 'bar', emoji: 'BAR' },
                { key: '7', emoji: '7️⃣' },
                { key: 'star', emoji: '⭐' },
                { key: 'watermelon', emoji: '🍉' },
                { key: 'bell', emoji: '🔔' },
                { key: 'mango', emoji: '🥭' },
                { key: 'orange', emoji: '🍊' },
                { key: 'apple', emoji: '🍎' }
            ];

            // Mapping for fruit hit sounds (musical interpretation of "saying" the fruit name)
            const fruitHitSounds = {
                'bar': "C4",
                '7': "D4",
                'star': "E4",
                'watermelon': "F4",
                'bell': "G4",
                'mango': "A4",
                'orange': "B4",
                'apple': "C5",
                'lucky-tab': "G5" // Special sound for lucky tab
            };

            // Mapping for more readable fruit names for history
            const fruitDisplayNames = {
                'orange': 'Orange',
                'bell': 'Bell',
                'bar': 'BAR',
                'apple': 'Apple',
                'mango': 'Mango',
                'watermelon': 'Watermelon',
                '7': 'Seven',
                'star': 'Star',
                'lucky-tab': 'Lucky Tab'
            };

            // Get a list of all bettable fruit data names (from fruitsData keys) for lucky bonus
            const allBettableFruitDataNames = Object.keys(fruitsData).filter(key =>
                fruitsData[key].type !== 'lucky' && fruitsData[key].type !== 'display'
            );

            /**
             * Shuffles an array in place using the Fisher-Yates (Knuth) algorithm.
             * @param {Array} array The array to shuffle.
             */
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]]; // Swap elements
                }
            }

            // Initialize fruit selection buttons for the new grid
            function initializeFruitButtons() {
                bettingCategories.forEach(category => {
                    const button = document.createElement('button');
                    button.classList.add('fruit-button');
                    button.dataset.category = category.key; // Use data-category for betting
                    // Only emoji and selection count
                    button.innerHTML = `${category.emoji}<br><span class="selection-count">00</span>`;
                    button.addEventListener('click', () => toggleFruitSelection(category.key));
                    fruitSelectionGrid.appendChild(button);
                });
            }

            function updateDisplay() {
                balanceDisplay.textContent = accountBalance.toFixed(2);
                currentStakeDisplay.textContent = currentStake.toFixed(2);
                availableBalanceDisplay.textContent = accountBalance.toFixed(2);
                goSubtext.textContent = `About to Pay ${currentStake.toFixed(0)}`;
            }

            function calculateStake() {
                let stake = 0;
                for (const category in selectedFruits) {
                    stake += selectedFruits[category] * currentBetAmount;
                }
                currentStake = stake;
                updateDisplay();
            }

            function toggleFruitSelection(categoryName) {
                const button = fruitSelectionGrid.querySelector(`[data-category="${categoryName}"]`);
                if (!button) return;

                const selectionCountSpan = button.querySelector('.selection-count');

                if (selectedFruits[categoryName]) {
                    if (selectedFruits[categoryName] === 1) {
                        selectedFruits[categoryName] = 2;
                        selectionCountSpan.textContent = '02';
                        button.classList.add('selected');
                    } else {
                        delete selectedFruits[categoryName];
                        button.classList.remove('selected');
                        selectionCountSpan.textContent = '00';
                    }
                } else {
                    if (Object.keys(selectedFruits).length < 8) {
                        selectedFruits[categoryName] = 1;
                        button.classList.add('selected');
                        selectionCountSpan.textContent = '01';
                    } else {
                        const messageBox = document.createElement('div');
                        messageBox.style.cssText = `
                            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                            background-color: #333; color: white; padding: 20px; border-radius: 10px;
                            box-shadow: 0 0 15px rgba(0,0,0,0.5); z-index: 1000; text-align: center;
                            font-size: 1.1em;
                        `;
                        messageBox.textContent = 'You can select a maximum of 8 fruits.';
                        document.body.appendChild(messageBox);
                        setTimeout(() => {
                            document.body.removeChild(messageBox);
                        }, 2000);
                        return;
                    }
                }
                calculateStake();
            }

            // This function now takes the exact data-fruit name from the board
            function calculateSingleFruitWin(hitFruitDataName, betMultiplier) {
                const fruitInfo = fruitsData[hitFruitDataName];
                if (!fruitInfo || fruitInfo.type === 'lucky' || fruitInfo.type === 'display') return 0;

                let stakeMultiplier = 0;
                if (fruitInfo.type === 'fixed') {
                    stakeMultiplier = fruitInfo.multiplier;
                } else if (fruitInfo.type === 'range') {
                    // Custom logic for range multipliers
                    if (fruitInfo.category === 'orange' || fruitInfo.category === 'mango' || fruitInfo.category === 'bell') {
                        // Big Mango / Orange / Bell: 10x fixed, 20% chance for 15x or 20x
                        stakeMultiplier = Math.random() < 0.2 ? [15, 20][Math.floor(Math.random() * 2)] : 10;
                    } else { // 'star', '7', 'watermelon'
                        // Big Double Star, Big 77, Big Watermelon: 20x fixed, 20% chance for 30x or 40x
                        stakeMultiplier = Math.random() < 0.2 ? [30, 40][Math.floor(Math.random() * 2)] : 20;
                    }
                }
                return stakeMultiplier * currentBetAmount * betMultiplier;
            }

            allX1Button.addEventListener('click', () => {
                selectedFruits = {};
                const fruitButtons = fruitSelectionGrid.querySelectorAll('.fruit-button');
                fruitButtons.forEach(button => {
                    button.classList.remove('selected'); // Clear selected state
                    button.querySelector('.selection-count').textContent = '00'; // Reset count
                });

                let selectedCount = 0;
                // Select up to 8 categories
                for (let i = 0; i < bettingCategories.length && selectedCount < 8; i++) {
                    const category = bettingCategories[i];
                    selectedFruits[category.key] = 1;
                    const button = fruitSelectionGrid.querySelector(`[data-category="${category.key}"]`);
                    if (button) {
                        button.classList.add('selected');
                        button.querySelector('.selection-count').textContent = '01';
                    }
                    selectedCount++;
                }
                calculateStake();
            });


            clearSelectionButton.addEventListener('click', () => {
                selectedFruits = {};
                const fruitButtons = fruitSelectionGrid.querySelectorAll('.fruit-button');
                fruitButtons.forEach(button => {
                    button.classList.remove('selected');
                    button.querySelector('.selection-count').textContent = '00';
                });
                calculateStake();
            });

            goButton.addEventListener('click', spin);

            async function spin() {
                // Stop any previous bonus blinking and clear highlights from all items
                if (bonusBlinkInterval) {
                    clearInterval(bonusBlinkInterval);
                    bonusBlinkInterval = null;
                }
                slotItems.forEach(item => item.classList.remove('highlight'));

                if (currentStake === 0) {
                    const messageBox = document.createElement('div');
                    messageBox.style.cssText = `
                        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                        background-color: #333; color: white; padding: 20px; border-radius: 10px;
                        box-shadow: 0 0 15px rgba(0,0,0,0.5); z-index: 1000; text-align: center;
                        font-size: 1.1em;
                    `;
                    messageBox.textContent = 'Please select fruits to bet on.';
                    document.body.appendChild(messageBox);
                    setTimeout(() => {
                        document.body.removeChild(messageBox);
                    }, 2000);
                    return;
                }
                if (accountBalance < currentStake) {
                    const messageBox = document.createElement('div');
                    messageBox.style.cssText = `
                        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                        background-color: #333; color: white; padding: 20px; border-radius: 10px;
                        box-shadow: 0 0 15px rgba(0,0,0,0.5); z-index: 1000; text-align: center;
                        font-size: 1.1em;
                    `;
                    messageBox.textContent = 'Insufficient balance. Current balance: KES ' + accountBalance.toFixed(2);
                    document.body.appendChild(messageBox);
                    setTimeout(() => {
                        document.body.removeChild(messageBox);
                    }, 2000);
                    return;
                }

                goButton.disabled = true;
                accountBalance -= currentStake;
                updateDisplay();
                currentWinDisplay.textContent = '0.00';
                winningDisplay.textContent = '00';

                let totalWinAmount = 0;
                let hitFruitsForBlink = []; // Array to store fruits that should blink after bonus animation

                // Determine game mode: 20% chance for special mode, 80% for normal spin
                const isSpecialMode = Math.random() < 0.20; // Adjust probability as needed

                if (isSpecialMode) {
                    // --- SPECIAL MODE: Animation + Bonus ---
                    addHistory("SPECIAL MODE: Animation + Bonus!");

                    // 1. Full Board Blinking Light-Up for 5 seconds
                    await Tone.start(); // Ensure audio context is started

                    let blinkState = false;
                    const blinkSoundInterval = 100; // Blink every 100ms
                    const initialBlinkDuration = 5000; // 5 seconds

                    const initialBlinkIntervalId = setInterval(() => {
                        blinkState = !blinkState;
                        slotItems.forEach(item => {
                            if (blinkState) {
                                item.classList.add('highlight');
                            } else {
                                item.classList.remove('highlight');
                            }
                        });
                        // Play a short sound for each blink
                        synth.triggerAttackRelease("C5", "64n", Tone.context.currentTime); // Schedule at current time
                    }, blinkSoundInterval);

                    addHistory("Board Blinking for 5 seconds!");
                    await new Promise(res => setTimeout(res, initialBlinkDuration)); // Wait for 5 seconds
                    clearInterval(initialBlinkIntervalId); // Stop initial blinking
                    // All highlights are removed by the interval, so we need to re-add them if they were supposed to stay
                    slotItems.forEach(item => item.classList.remove('highlight')); // Ensure all off before bonus

                    // 2. Random Reward Sequence Begins
                    await Tone.start(); // Ensure audio context is started
                    synth.triggerAttackRelease("D4", "16n"); // Sound for bonus sequence start


                    const animationType = Math.floor(Math.random() * 4); // 0–3

                    if (animationType === 0) {
                        // Option 1: x3 Fruits Highlight & Award
                        addHistory("Bonus Round: x3 Fruits!");
                        x3BonusSequence.start(); // Start bonus music
                        const x3Fruits = slotItems.filter(item => item.innerHTML.includes('x3'));
                        for (let fruitEl of x3Fruits) {
                            fruitEl.classList.add('highlight'); // Keep highlight
                            hitFruitsForBlink.push(fruitEl); // Add to blinking array
                            await new Promise(res => setTimeout(res, 10)); // Small delay for audio scheduling
                            synth.triggerAttackRelease("E5", "32n");
                            await new Promise(res => setTimeout(res, 300));

                            const hitFruitDataName = fruitEl.dataset.fruit;
                            const fruitCategory = fruitsData[hitFruitDataName].category;

                            if (selectedFruits[fruitCategory]) { // Check if the category was staked
                                const bonus = calculateSingleFruitWin(hitFruitDataName, selectedFruits[fruitCategory]);
                                totalWinAmount += bonus;
                                addHistory(`✨ BONUS x3 → ${fruitsData[hitFruitDataName].emoji} +KES ${bonus.toFixed(2)}`);
                                playFruitHitSound(fruitCategory); // Play sound for hit fruit
                            }
                        }
                        x3BonusSequence.stop(); // Stop bonus music
                    } else if (animationType === 1) {
                        // Option 2: Big Orange, Big Mango, Big Bell Award
                        addHistory("Bonus Round: Big Fruits!");
                        bigFruitBonusChord.triggerAttackRelease(["C4", "E4", "G4"], "1s"); // Play a chord for big fruit bonus
                        // Explicitly target one of each desired big fruit
                        const targetFruitDataNames = [
                            'big-orange-top-left',
                            'big-mango-top-right',
                            'big-bell-top'
                        ];
                        const targetElements = targetFruitDataNames.map(name =>
                            slotItems.find(item => item.dataset.fruit === name)
                        ).filter(Boolean); // Filter out any undefined if an element isn't found

                        for (let el of targetElements) {
                            el.classList.add('highlight'); // Keep highlight
                            hitFruitsForBlink.push(el); // Add to blinking array
                            await new Promise(res => setTimeout(res, 10)); // Small delay for audio scheduling
                            synth.triggerAttackRelease("G4", "16n");
                            await new Promise(res => setTimeout(res, 400));

                            const hitFruitDataName = el.dataset.fruit;
                            const fruitCategory = fruitsData[hitFruitDataName].category;

                            if (selectedFruits[fruitCategory]) { // Check if the category was staked
                                const bonus = calculateSingleFruitWin(hitFruitDataName, selectedFruits[fruitCategory]);
                                totalWinAmount += bonus;
                                addHistory(`✨ BONUS Big Fruit → ${fruitsData[hitFruitDataName].emoji} +KES ${bonus.toFixed(2)}`);
                                playFruitHitSound(fruitCategory); // Play sound for hit fruit
                            }
                        }
                    } else if (animationType === 2) {
                        // Option 3: Full Board Payout Reveal (All 28 Fruits)
                        addHistory("Bonus Round: Full Board Reveal!");
                        fullBoardSequence.start(); // Start bonus music
                        for (let el of slotItems) {
                            el.classList.add('highlight'); // Keep highlight
                            hitFruitsForBlink.push(el); // Add to blinking array
                            await new Promise(res => setTimeout(res, 10)); // Small delay for audio scheduling
                            synth.triggerAttackRelease("C5", "64n", Tone.context.currentTime);
                            await new Promise(res => setTimeout(res, 150));

                            const hitFruitDataName = el.dataset.fruit;
                            const fruitCategory = fruitsData[hitFruitDataName].category;
                            const fruitInfo = fruitsData[hitFruitDataName];

                            if (selectedFruits[fruitCategory] && fruitInfo && fruitInfo.type !== 'lucky' && fruitInfo.type !== 'display') {
                                const bonus = calculateSingleFruitWin(hitFruitDataName, selectedFruits[fruitCategory]);
                                totalWinAmount += bonus;
                                addHistory(`🎉 ALL HIT → ${fruitInfo.emoji} +KES ${bonus.toFixed(2)}`);
                                playFruitHitSound(fruitCategory); // Play sound for hit fruit
                            }
                        }
                        fullBoardSequence.stop(); // Stop bonus music
                    } else if (animationType === 3) {
                        // Option 4: All Apple Fruits Hit & Award
                        addHistory("Bonus Round: All Apples Hit!");
                        appleBonusMelody.start(); // Start bonus music
                        // Filter for all items that belong to the 'apple' category
                        const allAppleFruits = slotItems.filter(item => fruitsData[item.dataset.fruit]?.category === 'apple');

                        for (let appleEl of allAppleFruits) {
                            // Simulate swift movement to each apple
                            const currentLuckyFruitIndex = slotItems.indexOf(hitFruitsForBlink[hitFruitsForBlink.length - 1] || slotItems[0]); // Start from last hit or first item
                            const targetLuckyFruitIndex = slotItems.indexOf(appleEl);
                            const path = getPath(currentLuckyFruitIndex, targetLuckyFruitIndex, slotItems.length);

                            // Create a temporary moving sound synth for this segment
                            const tempMovingSynth = new Tone.Synth({
                                oscillator: { type: "sine" },
                                envelope: { attack: 0.01, decay: 0.05, sustain: 0.05, release: 0.05 }
                            }).toDestination();
                            const movingSoundLoop = new Tone.Loop(time => {
                                tempMovingSynth.triggerAttackRelease("C4", "32n", time);
                            }, "16n").start(0);

                            for (let k = 0; k < path.length; k++) {
                                const index = path[k];
                                slotItems[index].classList.add('highlight');
                                await new Promise(res => setTimeout(res, k < path.length - 3 ? 40 : 120)); // Swift then slow
                                slotItems[index].classList.remove('highlight');
                            }
                            movingSoundLoop.stop();
                            movingSoundLoop.dispose();
                            tempMovingSynth.dispose(); // Dispose the temporary synth

                            appleEl.classList.add('highlight'); // Keep highlight on the apple
                            hitFruitsForBlink.push(appleEl); // Add to blinking array

                            await Tone.start();
                            synth.triggerAttackRelease("E5", "16n", Tone.context.currentTime); // Distinct hit sound
                            playFruitHitSound(fruitsData[appleEl.dataset.fruit].category); // Play sound for hit apple
                            await new Promise(res => setTimeout(res, 300));

                            const hitFruitDataName = appleEl.dataset.fruit;
                            const fruitCategory = fruitsData[hitFruitDataName].category;
                            const fruitInfo = fruitsData[hitFruitDataName];

                            if (selectedFruits[fruitCategory] && fruitInfo && fruitInfo.type !== 'lucky' && fruitInfo.type !== 'display') {
                                const bonus = calculateSingleFruitWin(hitFruitDataName, selectedFruits[fruitCategory]);
                                totalWinAmount += bonus;
                                addHistory(`🍏 APPLE BONUS → ${fruitInfo.emoji} +KES ${bonus.toFixed(2)}`);
                            }
                        }
                        appleBonusMelody.stop(); // Stop bonus music
                    }

                } else {
                    // --- NORMAL SPIN (Default Mode) ---
                    addHistory("NORMAL SPIN: Simulating Spin...");

                    let currentHighlightIndex = 0;
                    let spinCount = 0;
                    const minFullCycles = 2;
                    const extraSteps = Math.floor(Math.random() * slotItems.length * 0.8) + 5;
                    const totalSpins = (minFullCycles * slotItems.length) + extraSteps;

                    // Start continuous moving sound
                    await Tone.start();
                    movingOscillator.start();

                    await new Promise(resolve => {
                        // Recursive function for the spin animation
                        const animateSpin = () => {
                            // Calculate dynamic delay for slowdown effect
                            const remainingSpins = totalSpins - spinCount;
                            let delay = 80; // Base delay
                            if (remainingSpins < 10) { // Start slowing down in the last 10 steps
                                delay = 80 + (10 - remainingSpins) * 20; // Increase delay by 20ms per step
                            } else if (remainingSpins < 20) { // Slightly earlier slowdown
                                delay = 80 + (20 - remainingSpins) * 5;
                            }

                            // Remove highlight from previous item
                            if (currentHighlightIndex > 0) {
                                slotItems[currentHighlightIndex - 1].classList.remove('highlight');
                            } else if (slotItems.length > 0) {
                                slotItems[slotItems.length - 1].classList.remove('highlight');
                            }

                            // Add highlight to current item
                            slotItems[currentHighlightIndex].classList.add('highlight');
                            // Play a quick sound for each spin step
                            synth.triggerAttackRelease("C6", "64n", Tone.context.currentTime);


                            currentHighlightIndex = (currentHighlightIndex + 1) % slotItems.length;
                            spinCount++;

                            if (spinCount >= totalSpins) {
                                movingOscillator.stop(); // Stop continuous sound
                                const finalWinningIndex = (currentHighlightIndex === 0) ? slotItems.length - 1 : currentHighlightIndex - 1;
                                const winningFruitElement = slotItems[finalWinningIndex];
                                const winningFruitDataName = winningFruitElement.dataset.fruit; // Get the specific data-fruit name

                                // Keep the final winning element highlighted
                                winningFruitElement.classList.add('highlight');
                                hitFruitsForBlink.push(winningFruitElement); // Add to blinking array

                                setTimeout(async () => { // Make this callback async
                                    totalWinAmount += await processNormalSpinWin(winningFruitDataName, winningFruitElement, hitFruitsForBlink); // Pass hitFruitsForBlink
                                    resolve(); // Resolve the main promise here
                                }, 500); // Small delay to show final highlight
                            } else {
                                setTimeout(animateSpin, delay); // Continue the loop with the calculated delay
                            }
                        };
                        animateSpin(); // Start the recursive animation
                    });
                }

                // This block runs AFTER both special mode animations/calculations OR normal spin completes
                accountBalance += totalWinAmount;
                currentWinDisplay.textContent = totalWinAmount.toFixed(2);
                winningDisplay.textContent = totalWinAmount > 0 ? totalWinAmount.toFixed(0) : '00';
                updateDisplay();
                goButton.disabled = false;

                // Start blinking for the hit fruit(s) after the game round is fully processed
                if (hitFruitsForBlink.length > 0) {
                    let blink = false;
                    bonusBlinkInterval = setInterval(() => {
                        blink = !blink;
                        hitFruitsForBlink.forEach(fruit => {
                            if (blink) {
                                fruit.classList.add('highlight');
                            } else {
                                fruit.classList.remove('highlight');
                            }
                        });
                    }, 500); // Blinks every 500ms
                }
            }

            // Helper function to get a path for the moving light
            function getPath(startIndex, endIndex, totalItems) {
                const path = [];
                let currentIndex = startIndex;

                // Determine direction (clockwise or counter-clockwise)
                const clockwiseDist = (endIndex - startIndex + totalItems) % totalItems;
                const counterClockwiseDist = (startIndex - endIndex + totalItems) % totalItems;

                let stepsToTake;
                let direction;

                if (clockwiseDist <= counterClockwiseDist) {
                    stepsToTake = clockwiseDist;
                    direction = 1; // Clockwise
                } else {
                    stepsToTake = counterClockwiseDist;
                    direction = -1; // Counter-clockwise
                }

                // Generate the path, including the target, but not the starting point
                for (let i = 0; i < stepsToTake; i++) {
                    currentIndex = (currentIndex + direction + totalItems) % totalItems;
                    path.push(currentIndex);
                }
                return path;
            }

            // Function to play a sound for a hit fruit
            function playFruitHitSound(fruitCategory) {
                const note = fruitHitSounds[fruitCategory];
                if (note) {
                    Tone.start().then(() => {
                        polySynth.triggerAttackRelease(note, "8n", Tone.context.currentTime);
                    }).catch(e => console.error("Tone.js audio start failed for fruit hit sound:", e));
                }
            }

            // New function for normal spin win processing
            async function processNormalSpinWin(winningFruitDataName, winningFruitElement, hitFruitsForBlink) { // Takes the specific data-fruit name and element
                let winAmount = 0;
                const fruitInfo = fruitsData[winningFruitDataName];
                const fruitCategory = fruitInfo.category; // Get the category of the hit fruit

                // Process win for the main winning fruit IF its category was staked on
                if (fruitInfo && fruitInfo.type !== 'lucky' && fruitInfo.type !== 'display') {
                    if (selectedFruits[fruitCategory]) { // Check if the category was staked
                        winAmount += calculateSingleFruitWin(winningFruitDataName, selectedFruits[fruitCategory]);
                        const displayName = fruitDisplayNames[fruitCategory] || fruitCategory; // Get readable name
                        addHistory(`Normal Spin Win: ${displayName} ${fruitInfo.emoji} → +KES ${winAmount.toFixed(2)}`); // Updated message
                        playFruitHitSound(fruitCategory); // Play sound for hit fruit
                    } else {
                        const displayName = fruitDisplayNames[fruitCategory] || fruitCategory;
                        addHistory(`Normal Spin: ${displayName} ${fruitInfo.emoji} (Not Staked)`); // Updated message
                    }
                }

                // Apply "Lucky" feature if lucky-tab is the main win
                if (winningFruitDataName.includes('lucky-tab')) {
                    addHistory("Lucky Tab Hit! Initiating Bonus...");
                    // The luckyTabElement is already highlighted and added to hitFruitsForBlink from spin()

                    // Create a *copy* of the potentialLuckyHitDataNames array to shuffle
                    const shuffledPotentialLuckyHitDataNames = [...allBettableFruitDataNames];
                    shuffleArray(shuffledPotentialLuckyHitDataNames); // Shuffle the copied array

                    const hits = Math.floor(Math.random() * 2) + 2; // 2–3 hits
                    const luckyHits = [];
                    // Pick 'hits' number of fruits from the shuffled array
                    for (let i = 0; i < hits && i < shuffledPotentialLuckyHitDataNames.length; i++) {
                        luckyHits.push(shuffledPotentialLuckyHitDataNames[i]);
                    }

                    for (let randHitDataName of luckyHits) { // Iterate over the selected lucky hits
                        const luckyFruitElement = slotItems.find(item => item.dataset.fruit === randHitDataName); // Find element by its exact data-fruit

                        if (luckyFruitElement) {
                            // Start moving sound for this segment
                            const luckyMovingSynth = new Tone.Synth({
                                oscillator: { type: "sine" },
                                envelope: { attack: 0.01, decay: 0.05, sustain: 0.05, release: 0.05 } // Shorter envelope for rapid sound
                            }).toDestination();
                            const movingSoundLoop = new Tone.Loop(time => {
                                luckyMovingSynth.triggerAttackRelease("C4", "32n", time); // Play a C4 note every 32nd note
                            }, "16n").start(0); // Faster repetition for swiftness

                            // Simulate swift movement
                            const currentLuckyFruitIndex = slotItems.indexOf(winningFruitElement); // Start from the lucky tab
                            const targetLuckyFruitIndex = slotItems.indexOf(luckyFruitElement);
                            const path = getPath(currentLuckyFruitIndex, targetLuckyFruitIndex, slotItems.length);

                            for (let k = 0; k < path.length; k++) {
                                const index = path[k];
                                slotItems[index].classList.add('highlight');
                                await new Promise(res => setTimeout(res, k < path.length - 3 ? 40 : 120)); // Swift then slow
                                slotItems[index].classList.remove('highlight');
                            }

                            // Stop moving sound for this segment
                            movingSoundLoop.stop();
                            movingSoundLoop.dispose(); // Dispose the loop after use
                            luckyMovingSynth.dispose(); // Dispose the temporary synth

                            luckyFruitElement.classList.add('highlight'); // Keep highlight
                            hitFruitsForBlink.push(luckyFruitElement); // Add to blinking array

                            await Tone.start();
                            synth.triggerAttackRelease("E5", "16n", Tone.context.currentTime); // Distinct hit sound
                            playFruitHitSound(fruitsData[randHitDataName].category); // Play sound for hit fruit
                            await new Promise(res => setTimeout(res, 300));

                            const luckyFruitCategory = fruitsData[randHitDataName].category;
                            // Process payout if the category was staked
                            if (selectedFruits[luckyFruitCategory]) {
                                const bonus = calculateSingleFruitWin(randHitDataName, selectedFruits[luckyFruitCategory]);
                                winAmount += bonus;
                                addHistory(`🍀 LUCKY HIT → ${fruitsData[randHitDataName].emoji} +KES ${bonus.toFixed(2)}`);
                            } else {
                                addHistory(`🍀 LUCKY MISS → ${fruitsData[randHitDataName].emoji} (Not Staked)`);
                            }
                        }
                    }
                    Tone.Transport.stop(); // Stop global transport after all lucky hits are done

                    await new Promise(res => setTimeout(res, 500)); // Final pause after all lucky hits
                }

                return winAmount;
            }


            function addHistory(text) {
                const listItem = document.createElement('li');
                listItem.innerHTML = text;
                historyList.prepend(listItem);

                while (historyList.children.length > 10) {
                    historyList.removeChild(historyList.lastChild);
                }
            }

            // Initial setup
            initializeFruitButtons();
            updateDisplay();
        });
    </script>
</body>
</html>
�
